[gcode_macro PRINT_START]
gcode:
  {% if 'BED' not in params %}
    {action_raise_error("BED not passed to PRINT_START macro")}
  {% endif %}
  {% if 'EXTRUDER' not in params %}
    {action_raise_error("EXTRUDER not passed to PRINT_START macro")}
  {% endif %}
  {% set target_bed = params.BED|int %}                  # Target bed temperature
  {% set target_extruder = params.EXTRUDER|int %}        # Target nozzle temperature
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}  # Bed center X
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}  # Bed center Y

  SET_GCODE_OFFSET Z=0                                   # Reset Z offset
  G28                                                    # Home all axes
  G90                                                    # Set to absolute positioning

  SET_DISPLAY_TEXT MSG="Heating Bed: {target_bed}°C"     # Display bed heating message
  G1 X{x_wait} Y{y_wait} Z15 F9000                       # Move to bed center
  M140 S{target_bed} ; Start heating bed
  SYNC_MOTORS
  M109 S150 ; Heat nozzle to soften filament leftovers
  M190 S{target_bed} ; Wait for bed to reach temperature
  G28 Z ; Home Z axis again to account for thermal expansion

  SET_DISPLAY_TEXT MSG="Leveling..."                    # Display leveling message
  Z_TILT_ADJUST                                          # Perform Z tilt adjustment
  G28 Z                                                  # Re-home Z after adjustment

  SET_DISPLAY_TEXT MSG="Bed Mesh Calibration..."            # Display mesh calibration message
  BED_MESH_CALIBRATE ADAPTIVE=1                          # Perform bed mesh calibration

  SET_DISPLAY_TEXT MSG="Calibrating Z Offset..."            # Display Z offset calibration message
  CARTOGRAPHER_TOUCH_HOME                                # Calibrate Z offset

  SET_DISPLAY_TEXT MSG="Heating Nozzle: {target_extruder}°C" # Display nozzle heating message
  G1 X{x_wait} Y{y_wait} Z15 F9000                       # Move to bed center
  M109 S{target_extruder}                                # Heat nozzle to target temperature

  SET_DISPLAY_TEXT MSG="Priming..."                         # Display preparation message
  SQUIGGLY_PURGE
  SET_DISPLAY_TEXT
  SKEW_PROFILE LOAD=default

[gcode_macro PRINT_END]
gcode:
  {% set th = printer.toolhead %}
  {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
  {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
  {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
  
  SAVE_GCODE_STATE NAME=STATE_PRINT_END

  M400
  TURN_OFF_HEATERS
  SET_SKEW CLEAR=1
  _TOOLHEAD_PARK_PAUSE_CANCEL
  M107
  SET_FAN_SPEED FAN=fan0 SPEED=0
  SET_FAN_SPEED FAN=fan3 SPEED=0

  
  BED_MESH_CLEAR
  RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0
